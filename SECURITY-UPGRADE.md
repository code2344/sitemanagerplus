# SiteManager+ Security & Feature Upgrade Summary

## üîê WebAuthn Hardware Key Authentication

### Flow
1. **First login**: Username + password
2. **Subsequent logins**: Hardware security key required (Yubikey, Touch ID, Windows Hello, etc.)
3. **Reset mechanism**: Offline OTP for emergency access

### Implementation
- Admin panel: `/admin` ‚Üí WebAuthn enforcement
- Ops panel: `/maintenance` ‚Üí WebAuthn enforcement
- Registration: Click "Register Hardware Key" in Security card
- Reset: Use 6-digit OTP generated by `bin/otp.sh <SESSION_SECRET>`

### OTP Generator (`bin/otp.sh`)
```bash
# Generate valid OTPs (current + last 4 minutes)
./bin/otp.sh <SESSION_SECRET>

# Example output:
# Valid OTPs (current and last 4 minutes):
# - 123456
# - 789012
# - 345678
# - 901234
# - 567890
```

### Reset Flow
1. Admin generates OTP offline using `bin/otp.sh`
2. Client provides OTP via panel or API: `POST /admin/reset-hw` with `{ otp: "123456" }`
3. Server validates OTP (5-minute window)
4. On success: clears hardware credentials
5. Client re-registers hardware key

---

## üéõÔ∏è Admin Panel Features (20+ Endpoints)

### Backups
- `POST /admin/backups/create` - Create full backup
- `GET /admin/backups/list` - List available backups
- `POST /admin/backups/restore` - Restore from backup

### Cache
- `POST /admin/cache/purge` - Clear cache

### SSL/TLS
- `POST /admin/ssl/generate` - Generate self-signed certificate
- `GET /admin/ssl/status` - Check certificate status

### Configuration
- `POST /admin/config/worker-count/update` - Adjust worker count

### Scheduled Tasks
- `GET /admin/scheduled/jobs` - List active scheduled jobs
- `POST /admin/scheduled/log-rotation/run` - Manually rotate logs

### Audit & Logs
- `GET /admin/audit/logs` - Retrieve audit log
- `POST /admin/logs` - Fetch recent logs
- `GET /admin/logs/list` - List log files

### Sessions
- `POST /admin/sessions/revoke-all` - Invalidate all sessions

### Alerts
- `POST /admin/alerts/test-email` - Test email alert system

### Webhooks
- `GET /admin/webhooks/list` - List configured webhooks
- `POST /admin/webhooks/test` - Test webhook delivery

### Static Site
- `GET /admin/static/size` - Calculate static site disk usage

### Maintenance Page
- `POST /admin/maintenance/page/edit` - Update maintenance page HTML

### Plugins
- `POST /admin/plugins/reload` - Reload plugins
- `POST /admin/plugins/:name/toggle` - Enable/disable plugin

### Metrics
- `GET /admin/metrics` - Prometheus format metrics
- `GET /admin/metrics/summary` - Metrics summary
- `POST /admin/metrics/reset` - Reset metric counters

### Tracing
- `POST /admin/tracing/toggle` - Enable/disable request tracing

### Security
- `POST /admin/security/headers/set` - Configure security headers

### Hardware Keys
- `POST /admin/webauthn/register/start` - Start registration
- `POST /admin/webauthn/register/verify` - Complete registration
- `POST /admin/webauthn/start` - Start authentication
- `POST /admin/webauthn/verify` - Complete authentication
- `POST /admin/reset-hw` - Reset hardware key with OTP
- `GET /admin/hw` - Hardware key verification page

---

## üîß Ops Panel Features (20+ Endpoints)

### Rolling Restarts
- `POST /maintenance/restart/rolling` - Graceful rolling restart

### Worker Control
- `POST /maintenance/restart/worker/:id` - Restart specific worker
- `POST /maintenance/restart/worker/:id/force` - Force kill worker

### Logs
- `GET /maintenance/logs` - Retrieve logs with filters
- `GET /maintenance/logs/files` - List log files with metadata
- `POST /maintenance/logs/rotate` - Manually rotate logs

### Cache
- `POST /maintenance/cache/clear` - Clear all caches

### Plugins
- `POST /maintenance/plugins/reload` - Reload plugin system

### Watchdog
- `POST /maintenance/watchdog/restart` - Restart watchdog
- `GET /maintenance/watchdog/status` - Watchdog status

### Thresholds
- `POST /maintenance/thresholds/update` - Update memory/CPU thresholds

### System Info
- `GET /maintenance/disk/usage` - Disk usage statistics
- `GET /maintenance/network/ports` - Active network ports
- `GET /maintenance/process/list` - Process list

### Backups (Ops)
- `POST /maintenance/static/backup` - Create ops-level backup
- `POST /maintenance/static/restore` - Restore from backup

### SSL
- `GET /maintenance/ssl/validate` - Validate SSL certificate

### Alerts
- `POST /maintenance/alerts/test` - Test alert system

### Tracing
- `POST /maintenance/tracing/toggle` - Enable/disable tracing

### Debug
- `POST /maintenance/debug/enable` - Enable debug mode
- `POST /maintenance/debug/disable` - Disable debug mode

### Health
- `GET /maintenance/health/run-check` - Manual health check

### Scheduled
- `GET /maintenance/scheduled/jobs` - List scheduled jobs

### Sessions
- `POST /maintenance/sessions/revoke-all` - Revoke all sessions

### Config
- `POST /maintenance/config/reload` - Reload configuration

### Maintenance Extension
- `POST /maintenance/maintenance/extend` - Extend maintenance window

### Hardware Keys
- `POST /maintenance/webauthn/register/start` - Start registration
- `POST /maintenance/webauthn/register/verify` - Complete registration
- `POST /maintenance/webauthn/start` - Start authentication
- `POST /maintenance/webauthn/verify` - Complete authentication
- `POST /maintenance/reset-hw` - Reset hardware key with OTP
- `GET /maintenance/hw` - Hardware key verification page

---

## üìù Files Changed

### New Files
- `src/utils/webauthn.js` - WebAuthn server-side logic
- `bin/otp.sh` - Offline OTP generator script

### Modified Files
- `src/utils/auth.js` - Added WebAuthn enforcement, OTP validation
- `src/panels/admin.js` - Added 20+ feature endpoints + WebAuthn routes
- `src/panels/maintenance.js` - Added 20+ ops endpoints + WebAuthn routes
- `src/panels/public/admin/index.html` - Added Security card, feature links
- `src/panels/public/admin/app.js` - Added HW key register/reset handlers
- `src/panels/public/maintenance/index.html` - Added Security card, feature links
- `src/panels/public/maintenance/app.js` - Added HW key register/reset handlers
- `package.json` - Added @simplewebauthn/server dependency
- `.env.example` - Added SESSION_SECRET documentation
- `README.md` - Documented hardware keys, OTP reset
- `ADVANCED-FEATURES.md` - Added feature endpoint sections
- `DEPLOYMENT-CHECKLIST.md` - Added hardware key registration step

---

## üöÄ Quick Start

### 1. Install dependencies
```bash
npm install
```

### 2. Start server
```bash
npm start
```

### 3. Login (first time)
- Navigate to `/admin` or `/maintenance`
- Enter username + password

### 4. Register hardware key
- Click "Register Hardware Key" in Security section
- Touch your security key when prompted

### 5. Test authentication
- Logout and login again
- Should require hardware key

### 6. Generate OTP for reset (if needed)
```bash
# Get SESSION_SECRET from data/session-secret or .env
./bin/otp.sh <SESSION_SECRET>
```

---

## üîí Security Notes

- Session tokens include `hw` flag (hardware verified)
- OTP uses HMAC-SHA256 with 1-minute counter
- Valid OTP window: current minute + last 4 minutes
- WebAuthn credentials stored in `data/webauthn.json`
- OTP script works completely offline
- SESSION_SECRET should be treated as master reset key

---

## üéØ Production Deployment

1. **Change default credentials** (ADMIN_PASSWORD, MAINTENANCE_PASSWORD)
2. **Register hardware keys** for admin and ops
3. **Save SESSION_SECRET** securely for emergency resets
4. **Enable HTTPS** (`ENABLE_HTTPS=true`)
5. **Configure email alerts** (Resend API key)
6. **Set up monitoring** (Prometheus metrics at `/admin/metrics`)
7. **Test OTP generator** before going live

---

## üìû Support

For help:
- Admin panel: `http://localhost:3000/admin`
- Ops panel: `http://localhost:3000/maintenance`
- Documentation: `ADVANCED-FEATURES.md`, `README.md`
- OTP reset: `./bin/otp.sh <SESSION_SECRET>`
